From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: zhangyuheng <zhangyuheng@lunadeer.cn>
Date: Thu, 8 Jan 2026 11:53:31 +0800
Subject: [PATCH] Network Optimization


diff --git a/net/minecraft/commands/Commands.java b/net/minecraft/commands/Commands.java
index c859197d643fd96ea2a5ef51837abc457e27f002..1441a6e76725910bdd8f98af66bce1b4df7aa792 100644
--- a/net/minecraft/commands/Commands.java
+++ b/net/minecraft/commands/Commands.java
@@ -232,9 +232,9 @@ public class Commands {
         //ReloadCommand.register(this.dispatcher); // Folia - region threading
         RecipeCommand.register(this.dispatcher);
         FetchProfileCommand.register(this.dispatcher);
-        //ReturnCommand.register(this.dispatcher); // Folia - region threading
-        RideCommand.register(this.dispatcher);
-        RotateCommand.register(this.dispatcher);
+        ReturnCommand.register(this.dispatcher); // Folia - region threading - TODO later
+        RideCommand.register(this.dispatcher); // Folia - region threading - TODO later
+        RotateCommand.register(this.dispatcher); // Folia - region threading - TODO later
         SayCommand.register(this.dispatcher);
         //ScheduleCommand.register(this.dispatcher); // Folia - region threading
         //ScoreboardCommand.register(this.dispatcher, context); // Folia - region threading
diff --git a/net/minecraft/network/Varint21FrameDecoder.java b/net/minecraft/network/Varint21FrameDecoder.java
index 2a5a744c8dfdea5d9a83f648e4cb10bfbbcee0df..54ec875efd3a1802e2745e91f289475f57dd3707 100644
--- a/net/minecraft/network/Varint21FrameDecoder.java
+++ b/net/minecraft/network/Varint21FrameDecoder.java
@@ -38,6 +38,37 @@ public class Varint21FrameDecoder extends ByteToMessageDecoder {
         throw new CorruptedFrameException("length wider than 21-bit");
     }
 
+    // DeerFolia start - Optimized VarInt reading
+    /**
+     * Read VarInt directly from buffer without copying to helper buffer
+     * Returns -1 if not enough data available
+     */
+    private static int readVarIntDirect(ByteBuf in) {
+        if (!in.isReadable()) {
+            return -1;
+        }
+
+        in.markReaderIndex();
+        int result = 0;
+        int byteCount = 0;
+
+        byte b;
+        do {
+            if (!in.isReadable()) {
+                in.resetReaderIndex();
+                return -1;
+            }
+            b = in.readByte();
+            result |= (b & 0x7F) << (byteCount++ * 7);
+            if (byteCount > 3) {
+                throw new CorruptedFrameException("length wider than 21-bit");
+            }
+        } while ((b & 0x80) != 0);
+
+        return result;
+    }
+    // DeerFolia end - Optimized VarInt reading
+
     @Override
     protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) {
         // Paper start - Perf: Optimize exception handling; if channel is not active just discard the packet
@@ -46,6 +77,29 @@ public class Varint21FrameDecoder extends ByteToMessageDecoder {
             return;
         }
         // Paper end - Perf: Optimize exception handling
+        // DeerFolia start - Optimized frame decoding
+        if (cn.lunadeer.mc.deerfolia.DeerFoliaConfiguration.networkOptimizations.optimizedVarInt) {
+            int readerIndexBefore = in.readerIndex();
+            int frameLength = readVarIntDirect(in);
+            if (frameLength == -1) {
+                return; // Not enough data
+            }
+            if (frameLength == 0) {
+                throw new CorruptedFrameException("Frame length cannot be zero");
+            }
+            if (in.readableBytes() < frameLength) {
+                in.readerIndex(readerIndexBefore);
+                return;
+            }
+
+            if (this.monitor != null) {
+                this.monitor.onReceive(frameLength + VarInt.getByteSize(frameLength));
+            }
+
+            out.add(in.readBytes(frameLength));
+            return;
+        }
+        // DeerFolia end - Optimized frame decoding
         in.markReaderIndex();
         this.helperBuf.clear();
         if (!copyVarint(in, this.helperBuf)) {
diff --git a/net/minecraft/network/Varint21LengthFieldPrepender.java b/net/minecraft/network/Varint21LengthFieldPrepender.java
index 0506cba28a41dc468d133b608b7cb182d2847e88..55dd9fffd28eb225b87adb5894f23ac1efeed121 100644
--- a/net/minecraft/network/Varint21LengthFieldPrepender.java
+++ b/net/minecraft/network/Varint21LengthFieldPrepender.java
@@ -17,6 +17,27 @@ public class Varint21LengthFieldPrepender extends MessageToByteEncoder<ByteBuf>
         if (byteSize > 3) {
             throw new EncoderException("Packet too large: size " + i + " is over 8");
         } else {
+            // DeerFolia start - Optimized frame encoding
+            if (cn.lunadeer.mc.deerfolia.DeerFoliaConfiguration.networkOptimizations.optimizedFrameEncoding) {
+                decoder.ensureWritable(byteSize + i);
+                // Inline VarInt writing for common cases (1-2 bytes cover most packets)
+                if (i < 128) {
+                    // 1 byte VarInt (most common case for small packets)
+                    decoder.writeByte(i);
+                } else if (i < 16384) {
+                    // 2 byte VarInt
+                    decoder.writeByte(i & 0x7F | 0x80);
+                    decoder.writeByte(i >>> 7);
+                } else {
+                    // 3 byte VarInt (rare, only for packets > 16KB)
+                    decoder.writeByte(i & 0x7F | 0x80);
+                    decoder.writeByte((i >>> 7) & 0x7F | 0x80);
+                    decoder.writeByte(i >>> 14);
+                }
+                decoder.writeBytes(encoder, encoder.readerIndex(), i);
+                return;
+            }
+            // DeerFolia end - Optimized frame encoding
             decoder.ensureWritable(byteSize + i);
             VarInt.write(decoder, i);
             decoder.writeBytes(encoder, encoder.readerIndex(), i);
